pipeline {
    agent {
		docker { image 'docker:24.0.2-dind-rootless'}
	}
  //    stage('Checkout') {
     //       steps {
                // Pull code from repository
      //          git branch: 'main', url: 'https;//github.com/nmn3m'
       //     }
       // }

   stages {
        stage('Build') {
            steps {
                script {
                    // Set up Docker environment
                    def dockerImage = 'instabug'
                    def dockerCmd = "docker"
                    def dockerRegistry = 'docker.io'
                    def dockerRepository = 'nmn3m/instabug'
                    def dockerTag = 'latest'
                    def dockerCredentialId = 'your-docker-credential-id'

                    // Build Docker image
                    sh "${dockerCmd} build -t ${dockerRegistry}/${dockerRepository}:${dockerTag} ."

                    // Check for build errors
                    def buildError = sh(
                        script: "${dockerCmd} build -t ${dockerRegistry}/${dockerRepository}:${dockerTag} .",
                        returnStatus: true
                    )

                    // Push Docker image if build successful
                    if (buildError == 0) {
                        // Docker login
                        withCredentials([usernamePassword(credentialsId: dockerCredentialId, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                            sh "${dockerCmd} login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD"
                        }

                        // Push Docker image
                        sh "${dockerCmd} push ${dockerRegistry}/${dockerRepository}:${dockerTag}"
                    } else {
                        error 'Build failed. Please check the build logs for errors.'
                    }
                }
            }
        }
    }
}